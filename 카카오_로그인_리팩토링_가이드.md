# 카카오 로그인 리팩토링 가이드

## ✅ 변경 사항 요약

카카오 로그인 구조를 안전한 OAuth 2.0 흐름으로 리팩토링했습니다.

### 주요 변경점

1. **REST API 키를 서버 전용으로 변경**
   - 기존: `NEXT_PUBLIC_KAKAO_REST_API_KEY` (클라이언트 노출 위험)
   - 변경: `KAKAO_REST_API_KEY` (서버 전용, `NEXT_PUBLIC_` 제거)

2. **클라이언트에서 SDK 제거**
   - 기존: 카카오 JavaScript SDK 사용 (`window.Kakao.Auth.authorize()`)
   - 변경: 직접 authorize URL 생성 및 리다이렉트

3. **안전한 OAuth 흐름**
   - 클라이언트: authorize URL로 리다이렉트만 수행
   - 서버: 토큰 교환 및 사용자 정보 처리

---

## 🔧 환경 변수 설정

### 로컬 개발 환경 (`.env.local`)

```env
# JavaScript 키 (클라이언트 전용)
NEXT_PUBLIC_KAKAO_JS_KEY=your_javascript_key_here

# REST API 키 (서버 전용 - NEXT_PUBLIC_ 없음!)
KAKAO_REST_API_KEY=your_rest_api_key_here
```

### Vercel 환경 변수 설정

1. Vercel 대시보드 → 프로젝트 → **Settings** → **Environment Variables**
2. 다음 환경 변수 추가/수정:

#### 클라이언트 전용 (NEXT_PUBLIC_ 접두사 있음)
- **Key**: `NEXT_PUBLIC_KAKAO_JS_KEY`
- **Value**: 카카오 개발자 콘솔의 JavaScript 키

#### 서버 전용 (NEXT_PUBLIC_ 접두사 없음)
- **Key**: `KAKAO_REST_API_KEY`
- **Value**: 카카오 개발자 콘솔의 REST API 키
- ⚠️ **중요**: `NEXT_PUBLIC_` 접두사를 붙이지 마세요!

---

## 📝 변경된 파일 목록

### 1. `lib/firebase/kakao.ts`
- 카카오 SDK 제거
- authorize URL 직접 생성
- `signInWithKakaoSDK()` 함수 단순화

### 2. `app/login/page.tsx`
- SDK 초기화 코드 제거
- `sdkReady` 상태 제거
- REST API 키 참조 제거

### 3. `app/api/auth/kakao/callback/route.ts`
- `process.env.KAKAO_REST_API_KEY` 사용 (서버 전용)
- `NEXT_PUBLIC_KAKAO_REST_API_KEY` 참조 제거

### 4. `lib/webhooks/kakao-verify.ts`
- `process.env.KAKAO_REST_API_KEY` 사용 (서버 전용)

### 5. `lib/firebase/auth.ts`
- 카카오 SDK 로그아웃 코드 제거
- 로컬 스토리지 정리만 유지

### 6. `app/test-kakao/page.tsx`
- SDK 테스트 제거
- authorize URL 생성 테스트 추가
- REST API 키는 서버 전용임을 명시

### 7. `env.local.example`
- 환경 변수 설명 업데이트
- REST API 키는 서버 전용임을 명시

---

## 🔄 마이그레이션 가이드

### 1. 환경 변수 업데이트

#### 로컬 개발 환경
`.env.local` 파일을 열고:

```env
# 기존 (제거)
# NEXT_PUBLIC_KAKAO_REST_API_KEY=...

# 새로 추가 (NEXT_PUBLIC_ 없음!)
KAKAO_REST_API_KEY=your_rest_api_key_here
```

#### Vercel 환경 변수
1. Vercel 대시보드 접속
2. 프로젝트 → Settings → Environment Variables
3. `NEXT_PUBLIC_KAKAO_REST_API_KEY` 삭제 (또는 이름 변경)
4. `KAKAO_REST_API_KEY` 추가 (값은 동일)

### 2. 코드 변경 확인

모든 파일이 자동으로 업데이트되었습니다. 다음을 확인하세요:

- ✅ `NEXT_PUBLIC_KAKAO_REST_API_KEY` 참조가 모두 제거되었는지
- ✅ 서버 파일에서 `KAKAO_REST_API_KEY` 사용하는지
- ✅ 클라이언트 파일에서 REST API 키를 참조하지 않는지

### 3. 테스트

1. 로컬에서 테스트:
   ```bash
   npm run dev
   ```
   - `http://localhost:3000/login` 접속
   - 카카오 로그인 버튼 클릭
   - 정상적으로 카카오 로그인 페이지로 이동하는지 확인

2. Vercel 배포 후 테스트:
   - Vercel에 배포
   - 환경 변수 설정 확인
   - 프로덕션 환경에서 카카오 로그인 테스트

---

## 🔒 보안 개선 사항

### 이전 구조의 문제점
- REST API 키가 클라이언트에 노출됨 (`NEXT_PUBLIC_` 접두사)
- 브라우저 개발자 도구에서 키 확인 가능
- 키 유출 시 악용 가능

### 개선된 구조
- REST API 키는 서버에서만 사용
- 클라이언트는 JavaScript 키만 사용 (authorize URL 생성용)
- OAuth 2.0 표준 흐름 준수

---

## 📚 OAuth 2.0 흐름

### 1. 클라이언트 (브라우저)
```
사용자 클릭 → authorize URL 생성 → 카카오 로그인 페이지로 리다이렉트
```

### 2. 카카오 서버
```
사용자 로그인 → 인가 코드(code) 생성 → 콜백 URL로 리다이렉트
```

### 3. 서버 (Next.js API Route)
```
인가 코드 수신 → REST API 키로 토큰 교환 → 사용자 정보 조회 → Firebase Custom Token 생성
```

### 4. 클라이언트
```
Firebase Custom Token 수신 → Firebase 로그인 완료
```

---

## ⚠️ 주의사항

1. **환경 변수 이름**
   - 서버 전용: `KAKAO_REST_API_KEY` (NEXT_PUBLIC_ 없음)
   - 클라이언트 전용: `NEXT_PUBLIC_KAKAO_JS_KEY` (NEXT_PUBLIC_ 있음)

2. **Vercel 환경 변수**
   - `KAKAO_REST_API_KEY`는 서버에서만 접근 가능
   - `NEXT_PUBLIC_` 접두사를 붙이면 클라이언트에 노출됨

3. **카카오 개발자 콘솔**
   - Redirect URI 등록: `https://your-domain.com/api/auth/kakao/callback`
   - JavaScript 키와 REST API 키는 다를 수 있음

---

## 🐛 문제 해결

### 에러: "REST API 키가 설정되지 않았습니다"
- 원인: `KAKAO_REST_API_KEY` 환경 변수가 설정되지 않음
- 해결: `.env.local` 또는 Vercel 환경 변수에 `KAKAO_REST_API_KEY` 추가

### 에러: "invalid_client"
- 원인: REST API 키가 잘못되었거나 서버에서 접근 불가
- 해결: 
  1. 카카오 개발자 콘솔에서 REST API 키 확인
  2. 환경 변수 이름이 `KAKAO_REST_API_KEY`인지 확인 (NEXT_PUBLIC_ 없음)
  3. Vercel에서 환경 변수 재설정 후 재배포

### 에러: "redirect_uri_mismatch"
- 원인: 카카오 개발자 콘솔에 Redirect URI가 등록되지 않음
- 해결: 카카오 개발자 콘솔에서 Redirect URI 등록 확인

---

## 📞 추가 도움

문제가 발생하면:
1. 브라우저 콘솔 확인 (F12)
2. 서버 로그 확인 (Vercel Functions 로그)
3. 환경 변수 설정 확인
4. 카카오 개발자 콘솔 설정 확인
